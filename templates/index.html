<!-- 
    TEMPLATE INDEX - index.html  
    ============================
    
    P√°gina inicial que exibe o cat√°logo de produtos da adega
    
    Conceitos abordados:
    - Heran√ßa de templates (extends)
    - Loops em templates (for)
    - Condicionais em templates (if)
    - Formul√°rios
    - Cards Bootstrap
    - Grid System Bootstrap
    - JavaScript/AJAX
-->

{% extends "base.html" %}
<!-- 
    extends: Herda tudo do template base.html
    Permite reutilizar estrutura, CSS e JavaScript
-->

{% block title %}Cat√°logo - Adega R√°dio Tatuap√© FM{% endblock %}
<!-- Substitui o t√≠tulo padr√£o do template base -->

{% block content %}
<!-- HERO SECTION: Se√ß√£o de destaque principal -->
<section class="hero-section bg-primary text-white text-center py-5 mb-5 rounded">
    <!-- 
        Classes explicadas:
        - bg-primary: Background azul do Bootstrap
        - text-center: Centraliza o texto
        - py-5: Padding vertical grande
        - mb-5: Margin bottom grande
        - rounded: Bordas arredondadas
    -->
    <div class="container">
        <h1 class="display-4 fw-bold">
            <!-- display-4: T√≠tulo grande, fw-bold: Fonte em negrito -->
            <i class="fas fa-wine-bottle me-3"></i>
            Adega R√°dio Tatuap√© FM
        </h1>
        <p class="lead mb-4">
            <!-- lead: Texto destacado/maior -->
            Bem-vindo √† Adega 24 Horas Radio Tatuap√© FM, o seu o√°sis de sabores acess√≠veis! 
            Momentos especiais n√£o precisam ser caros - aqui a divers√£o √© garantida e os pre√ßos n√£o v√£o te impedir de aproveitar cada gole.
        </p>
        <div class="row justify-content-center">
            <div class="col-md-8">
                <div class="row text-start">
                    <!-- text-start: Alinha texto √† esquerda -->
                    <div class="col-md-6">
                        <p class="mb-2">
                            <i class="fas fa-check-circle me-2 text-success"></i>
                            Entrega via WhatsApp
                        </p>
                        <p class="mb-2">
                            <i class="fas fa-check-circle me-2 text-success"></i>
                            Pagamento via PIX
                        </p>
                    </div>
                    <div class="col-md-6">
                        <p class="mb-2">
                            <i class="fas fa-check-circle me-2 text-success"></i>
                            Funcionamento 24h
                        </p>
                        <p class="mb-2">
                            <i class="fas fa-check-circle me-2 text-success"></i>
                            Produtos sempre gelados
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- FILTROS DE CATEGORIA -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <!-- Card: Container com sombra e bordas -->
            <div class="card-body">
                <h5 class="card-title">
                    <i class="fas fa-filter me-2"></i>Filtrar por categoria
                </h5>
                <div class="btn-group flex-wrap" role="group">
                    <!-- 
                        btn-group: Agrupa bot√µes
                        flex-wrap: Permite quebra de linha em telas pequenas
                    -->
                    <a href="{{ url_for('index') }}" class="btn btn-outline-primary">
                        <i class="fas fa-th-large me-1"></i>Todos
                    </a>
                    <a href="?categoria=cerveja" class="btn btn-outline-primary">
                        üç∫ Cervejas
                    </a>
                    <a href="?categoria=vinho" class="btn btn-outline-primary">
                        üç∑ Vinhos
                    </a>
                    <a href="?categoria=destilados" class="btn btn-outline-primary">
                        ü•É Destilados
                    </a>
                    <a href="?categoria=refrigerante" class="btn btn-outline-primary">
                        ü•§ Refrigerantes
                    </a>
                    <a href="?categoria=agua" class="btn btn-outline-primary">
                        üíß √Ågua
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- CAT√ÅLOGO DE PRODUTOS -->
<div class="row">
    <div class="col-12">
        <h2 class="mb-4">
            <i class="fas fa-shopping-bag me-2"></i>Nossos Produtos
        </h2>
    </div>
</div>

<!-- VERIFICA√á√ÉO SE H√Å PRODUTOS -->
{% if produtos %}
    <!-- Grid de Produtos usando Bootstrap -->
    <div class="row" id="produtos-grid">
        <!-- 
            Bootstrap Grid System:
            - row: Cria uma linha
            - col-*: Define colunas responsivas
            - lg/md/sm: Breakpoints para diferentes tamanhos de tela
        -->
        
        {% for produto in produtos %}
        <!-- 
            Loop Jinja2: Itera sobre cada produto
            produto √© uma inst√¢ncia do modelo Produto do SQLAlchemy
        -->
        <div class="col-lg-4 col-md-6 col-sm-12 mb-4">
            <!-- 
                Colunas responsivas:
                - col-lg-4: 3 produtos por linha em telas grandes
                - col-md-6: 2 produtos por linha em tablets
                - col-sm-12: 1 produto por linha em celulares
                - mb-4: Margin bottom entre produtos
            -->
            
            <!-- CARD DO PRODUTO -->
            <div class="card h-100 produto-card">
                <!-- 
                    h-100: Altura 100% (todos os cards ficam da mesma altura)
                    produto-card: Classe personalizada para CSS
                -->
                
                <!-- IMAGEM DO PRODUTO -->
                <div class="card-img-wrapper">
                    <img src="{{ produto.imagem_url or '/static/images/default-product.jpg' }}" 
                         class="card-img-top" 
                         alt="{{ produto.nome }}"
                         loading="lazy">
                    <!-- 
                        src: URL da imagem (usa imagem padr√£o se n√£o houver)
                        loading="lazy": Carrega imagem apenas quando necess√°rio (otimiza√ß√£o)
                        alt: Texto alternativo para acessibilidade
                    -->
                    
                    <!-- BADGE DE CATEGORIA -->
                    <span class="position-absolute top-0 end-0 m-2">
                        <span class="badge bg-secondary">
                            {{ produto.categoria.title() }}
                            <!-- .title(): Deixa primeira letra mai√∫scula -->
                        </span>
                    </span>
                    
                    <!-- BADGE DE ESTOQUE (se baixo) -->
                    {% if produto.estoque <= 5 %}
                    <span class="position-absolute bottom-0 start-0 m-2">
                        <span class="badge bg-warning text-dark">
                            √öltimas unidades!
                        </span>
                    </span>
                    {% endif %}
                </div>
                
                <!-- CORPO DO CARD -->
                <div class="card-body d-flex flex-column">
                    <!-- 
                        d-flex flex-column: Layout flexbox vertical
                        Permite que o bot√£o fique sempre no final do card
                    -->
                    
                    <!-- NOME DO PRODUTO -->
                    <h5 class="card-title">{{ produto.nome }}</h5>
                    
                    <!-- DESCRI√á√ÉO -->
                    <p class="card-text text-muted flex-grow-1">
                        <!-- 
                            flex-grow-1: Expande para ocupar espa√ßo dispon√≠vel
                            Empurra o pre√ßo e bot√£o para baixo
                        -->
                        {{ produto.descricao[:100] }}...
                        <!-- [:100]: Limita descri√ß√£o a 100 caracteres -->
                    </p>
                    
                    <!-- PRE√áO -->
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <span class="h4 text-success mb-0">
                            {{ produto.preco|currency }}
                            <!-- 
                                |currency: Filtro personalizado definido no app.py
                                Formata o pre√ßo como moeda brasileira
                            -->
                        </span>
                        <small class="text-muted">
                            Estoque: {{ produto.estoque }}
                        </small>
                    </div>
                    
                    <!-- FORMUL√ÅRIO PARA ADICIONAR AO CARRINHO -->
                    <form class="add-to-cart-form" data-produto-id="{{ produto.id }}">
                        <!-- 
                            data-produto-id: Atributo personalizado para JavaScript
                            Permite identificar o produto via AJAX
                        -->
                        
                        <div class="row g-2 mb-3">
                            <!-- g-2: Gap (espa√ßamento) pequeno entre colunas -->
                            
                            <div class="col-8">
                                <div class="input-group">
                                    <!-- input-group: Agrupa elementos de input -->
                                    
                                    <button class="btn btn-outline-secondary btn-sm qty-decrease" 
                                            type="button"
                                            data-action="decrease">
                                        <i class="fas fa-minus"></i>
                                    </button>
                                    
                                    <input type="number" 
                                           class="form-control form-control-sm text-center quantidade-input" 
                                           name="quantidade" 
                                           value="1" 
                                           min="1" 
                                           max="{{ produto.estoque }}">
                                    
                                    <button class="btn btn-outline-secondary btn-sm qty-increase" 
                                            type="button"
                                            data-action="increase">
                                        <i class="fas fa-plus"></i>
                                    </button>
                                </div>
                            </div>
                            
                            <div class="col-4">
                                <button type="submit" 
                                        class="btn btn-primary btn-sm w-100"
                                        {% if produto.estoque == 0 %}disabled{% endif %}>
                                    <!-- 
                                        Bot√£o desabilitado se n√£o h√° estoque
                                        w-100: Width 100% (bot√£o ocupa toda largura)
                                    -->
                                    <i class="fas fa-cart-plus"></i>
                                </button>
                            </div>
                        </div>
                        
                        <!-- INPUT HIDDEN COM ID DO PRODUTO -->
                        <input type="hidden" name="produto_id" value="{{ produto.id }}">
                        <!-- 
                            hidden: Campo invis√≠vel que envia o ID do produto
                            Necess√°rio para identificar qual produto adicionar
                        -->
                    </form>
                    
                    <!-- BOT√ÉO VER DETALHES (REDIRECIONA PARA IFOOD) -->
                    <a href="https://www.ifood.com.br/delivery/sao-paulo-sp/adega-radio-tatuape-fm-24-horas-vila-regente-feijo" 
                       class="btn btn-outline-info btn-sm" target="_blank">
                        <i class="fas fa-external-link-alt me-1"></i>Ver detalhes
                    </a>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    
{% else %}
    <!-- MENSAGEM QUANDO N√ÉO H√Å PRODUTOS -->
    <div class="col-12">
        <div class="alert alert-info text-center">
            <i class="fas fa-info-circle me-2"></i>
            <strong>Nenhum produto encontrado!</strong>
            <p class="mb-0 mt-2">
                Verifique os filtros ou entre em contato conosco.
            </p>
        </div>
    </div>
{% endif %}

<!-- SE√á√ÉO DE CONTATO/INFORMA√á√ïES -->
<section class="mt-5 pt-5 border-top">
    <!-- border-top: Linha superior separadora -->
    <div class="row">
        <div class="col-md-6">
            <div class="card bg-light">
                <div class="card-body text-center">
                    <i class="fas fa-whatsapp text-success fa-3x mb-3"></i>
                    <h5>Fa√ßa seu pedido!</h5>
                    <p class="text-muted">
                        Adicione produtos ao carrinho e envie via WhatsApp
                    </p>
                    <a href="{{ url_for('carrinho') }}" class="btn btn-success">
                        <i class="fas fa-shopping-cart me-2"></i>
                        Ver Carrinho ({{ carrinho_total_itens or 0 }})
                    </a>
                </div>
            </div>
        </div>
        
        <div class="col-md-6">
            <div class="card bg-light">
                <div class="card-body text-center">
                    <i class="fas fa-money-check text-primary fa-3x mb-3"></i>
                    <h5>Pagamento PIX</h5>
                    <p class="text-muted">
                        Pagamento r√°pido e seguro via PIX
                    </p>
                    <strong>radiotatuapefm@gmail.com</strong>
                </div>
            </div>
        </div>
    </div>
</section>
{% endblock %}

<!-- SCRIPTS ESPEC√çFICOS DESTA P√ÅGINA -->
{% block extra_scripts %}
<script>
    // JavaScript espec√≠fico da p√°gina inicial
    // =======================================
    
    document.addEventListener('DOMContentLoaded', function() {
        console.log('P√°gina inicial carregada. Inicializando funcionalidades...');
        
        // FUNCIONALIDADE: Bot√µes +/- para quantidade
        // ==========================================
        setupQuantityButtons();
        
        // FUNCIONALIDADE: Adicionar ao carrinho via AJAX
        // ==============================================
        setupAddToCartForms();
        
        // FUNCIONALIDADE: Anima√ß√£o nos cards
        // =================================
        setupCardAnimations();
    });
    
    function setupQuantityButtons() {
        // Busca todos os bot√µes de quantidade
        const decreaseButtons = document.querySelectorAll('.qty-decrease');
        const increaseButtons = document.querySelectorAll('.qty-increase');
        
        // Event listeners para bot√µes de diminuir
        decreaseButtons.forEach(button => {
            button.addEventListener('click', function() {
                const input = this.parentNode.querySelector('.quantidade-input');
                let value = parseInt(input.value);
                
                if (value > 1) {  // M√≠nimo 1
                    input.value = value - 1;
                }
            });
        });
        
        // Event listeners para bot√µes de aumentar
        increaseButtons.forEach(button => {
            button.addEventListener('click', function() {
                const input = this.parentNode.querySelector('.quantidade-input');
                const max = parseInt(input.getAttribute('max'));
                let value = parseInt(input.value);
                
                if (value < max) {  // Respeitando estoque m√°ximo
                    input.value = value + 1;
                }
            });
        });
    }
    
    function setupAddToCartForms() {
        // Busca todos os formul√°rios de adicionar ao carrinho
        const forms = document.querySelectorAll('.add-to-cart-form');
        
        forms.forEach(form => {
            form.addEventListener('submit', function(e) {
                e.preventDefault();  // Previne envio tradicional do formul√°rio
                
                // Coleta dados do formul√°rio
                const produtoId = this.dataset.produtoId;
                const quantidade = this.querySelector('input[name="quantidade"]').value;
                const submitButton = this.querySelector('button[type="submit"]');
                
                // Desabilita bot√£o durante envio
                submitButton.disabled = true;
                submitButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
                
                // Faz requisi√ß√£o AJAX
                fetch('/adicionar_carrinho', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        produto_id: parseInt(produtoId),
                        quantidade: parseInt(quantidade)
                    })
                })
                .then(response => response.json())  // Converte resposta para JSON
                .then(data => {
                    if (data.success) {
                        // Atualiza badge do carrinho
                        atualizarBadgeCarrinho(data.total_itens);
                        
                        // Mostra feedback visual
                        showToast('Produto adicionado ao carrinho!', 'success');
                        
                        // Reset do formul√°rio
                        this.querySelector('input[name="quantidade"]').value = 1;
                    } else {
                        showToast(data.error || 'Erro ao adicionar produto', 'error');
                    }
                })
                .catch(error => {
                    console.error('Erro:', error);
                    showToast('Erro de conex√£o', 'error');
                })
                .finally(() => {
                    // Reabilita bot√£o
                    submitButton.disabled = false;
                    submitButton.innerHTML = '<i class="fas fa-cart-plus"></i>';
                });
            });
        });
    }
    
    function setupCardAnimations() {
        // Anima√ß√£o sutil ao passar mouse nos cards
        const cards = document.querySelectorAll('.produto-card');
        
        cards.forEach(card => {
            card.addEventListener('mouseenter', function() {
                this.style.transform = 'translateY(-5px)';
                this.style.transition = 'transform 0.3s ease';
            });
            
            card.addEventListener('mouseleave', function() {
                this.style.transform = 'translateY(0)';
            });
        });
    }
    
    // Fun√ß√£o para mostrar notifica√ß√µes toast
    function showToast(message, type = 'info') {
        // Cria elemento toast
        const toast = document.createElement('div');
        toast.className = `alert alert-${type === 'success' ? 'success' : 'danger'} position-fixed`;
        toast.style.cssText = 'top: 20px; right: 20px; z-index: 1050; min-width: 300px;';
        toast.innerHTML = `
            ${message}
            <button type="button" class="btn-close" onclick="this.parentElement.remove()"></button>
        `;
        
        // Adiciona ao DOM
        document.body.appendChild(toast);
        
        // Remove automaticamente ap√≥s 3 segundos
        setTimeout(() => {
            if (toast.parentNode) {
                toast.remove();
            }
        }, 3000);
    }
</script>
{% endblock %}
